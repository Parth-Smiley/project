<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Chat - Patient</title>
  <style>
    body {
      margin:0;
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #f0f7ff 0%, #e6f2ff 100%);
    }
    .container { display:flex; height:100vh; }
    .sidebar {
      width:280px; background:#fff;
      border-right:1px solid #ddd;
      display:flex; flex-direction:column;
    }
    .sidebar h2 {
      padding:20px; margin:0;
      background: linear-gradient(to right, #2c7dff, #00b8ff);
      color:#fff; font-size:20px; font-weight:600;
    }
    .contact {
  position: relative;
  padding: 15px 20px;
  border-bottom: 1px solid #f0f0f0;
  text-decoration: none;
  color: #333;
  display: block;
}
.contact.unread::after {
  content: '';
  position: absolute;
  right: 15px;
  top: 50%;
  transform: translateY(-50%);
  width: 10px;
  height: 10px;
  background: #2c7dff;
  border-radius: 50%;

    }
    .contact:hover { background:#f7faff; }
    .contact.active { background:#e6f0ff; font-weight:600; }
    .chat-window { flex:1; display:flex; flex-direction:column; }
    .chat-header {
      padding:18px 20px;
      background:#fff;
      border-bottom:1px solid #ddd;
      font-weight:600;
      font-size:18px;
      color:#2c7dff;
      box-shadow:0 2px 6px rgba(0,0,0,0.05);
    }
    .chat-box {
      flex:1; padding:20px;
      overflow-y:auto;
      background:#f4f8ff;
      display:flex; flex-direction:column;
    }
    .msg {
      margin:8px 0;
      padding:12px 16px;
      border-radius:18px;
      max-width:65%;
      box-shadow:0 2px 5px rgba(0,0,0,0.05);
    }
    .msg.patient {
      background: linear-gradient(to right, #2c7dff, #00b8ff);
      color:#fff;
      align-self:flex-end;
      border-bottom-right-radius:5px;
    }
    .msg.doctor {
      background:#fff;
      align-self:flex-start;
      border-bottom-left-radius:5px;
    }
    .form-box {
      display:flex;
      padding:15px;
      background:#fff;
      border-top:1px solid #ddd;
    }
    .form-box input {
      flex:1;
      padding:12px 15px;
      border:1px solid #ccc;
      border-radius:25px;
      outline:none;
      font-size:15px;
    }
    .form-box button {
      margin-left:10px;
      padding:12px 20px;
      border:none;
      border-radius:25px;
      background:linear-gradient(to right, #2c7dff, #00b8ff);
      color:#fff;
      font-weight:600;
      cursor:pointer;
      transition:0.2s;
    }
    .form-box button:hover { opacity:0.9; }
  </style>
</head>
<body>
  <div class="container">
    <!-- Sidebar -->
    <div class="sidebar">
      <h2>Doctors</h2>
      {% for doc, details in doctors.items() %}
        <a class="contact {% if active_doctor == doc %}active{% endif %}"
           href="{{ url_for('chat') }}?doctor={{ doc|urlencode }}">
          {{ doc }} ({{ details['specialty'] }})
        </a>
      {% endfor %}
    </div>

    <!-- Chat Window -->
    <div class="chat-window">
      {% if active_doctor %}
        <div class="chat-header">Chat with {{ active_doctor }}</div>
        <div class="chat-box" id="chat-box">
          {% for msg in messages %}
            <div class="msg {{ msg.sender }}">
              {% if msg.sender == 'patient' %}You: {{ msg.text }}
              {% else %}{{ active_doctor }}: {{ msg.text }}{% endif %}
            </div>
          {% endfor %}
        </div>
        <form method="POST" class="form-box">
          <input type="text" name="message" placeholder="Type a message..." required>
          <button type="submit">Send</button>
        </form>
      {% else %}
        <div class="chat-header">Select a doctor to start chatting</div>
      {% endif %}
    </div>
  </div>

  <!-- Socket.IO client -->
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
  const socket = io();
  const activeDoctor = "{{ active_doctor|default('') }}";
  const patientUsername = "{{ username|default('') }}";

  socket.on("new_message", function(data) {
    const chatBox = document.getElementById("chat-box");

    // Case 1: Active chat
    if (activeDoctor && data.patient === patientUsername && data.doctor === activeDoctor) {
      let div = document.createElement("div");
      div.classList.add("msg", data.sender);
      div.textContent = (data.sender === "patient" ? "You: " : activeDoctor + ": ") + data.text;
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    } 
    // Case 2: Message from another doctor â†’ mark unread
    else if (data.patient === patientUsername) {
      let contactElem = document.querySelector(`.contact[href*="doctor=${encodeURIComponent(data.doctor)}"]`);
      if (contactElem) {
        contactElem.classList.add("unread");
      }
    }
  });

  // Clear unread dot when opening a chat
  document.querySelectorAll(".contact").forEach(c => {
    c.addEventListener("click", () => c.classList.remove("unread"));
  });
</script>

</body>
</html>
